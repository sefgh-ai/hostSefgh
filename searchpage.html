<!DOCTYPE html>
<html lang="en" class="light">
<head>
      <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-3J37CNB3YE"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-3J37CNB3YE");
    </script>

    <meta
      name="description"
      content="Discover hidden GitHub gems with SEFGH's intelligent search. Go beyond keywords with natural language queries and find projects that truly match your needs. Perfect for developers, data scientists, and researchers."
    />
    <meta
      name="keywords"
      content="GitHub search tool, GitHub project discovery, smart GitHub search, find GitHub projects, GitHub repository search engine, discover GitHub gems, open source project finder"
    />
    <meta name="author" content="SEFGH" />
    <meta name="robots" content="index, follow" />

    <!-- Canonical URL -->
    <link rel="canonical" href="https://sefgh.org/searchpage" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://sefgh.org/searchpage" />
    <meta
      property="og:title"
      content="SEFGH - Search Engine For Github, Smart GitHub Project Discovery Tool"
    />
    <meta
      property="og:description"
      content="Discover hidden GitHub gems with SEFGH's intelligent search. Go beyond keywords with natural language queries and find projects that truly match your needs."
    />
    <meta
      property="og:image"
      content="https://sefgh.org/assets/sefgh-social-preview.jpg"
    />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:site_name" content="SEFGH" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://sefgh.org/searchpage" />
    <meta property="twitter:title" content="SEFGH - Search Engine For Github" />
    <meta
      property="twitter:description"
      content="Discover hidden GitHub gems with SEFGH's intelligent search. Go beyond keywords with natural language queries and find projects that truly match your needs."
    />
    <meta
      property="twitter:image"
      content="https://sefgh.org/assets/sefgh-social-preview.jpg"
    />
    <meta name="twitter:creator" content="@sefgh" />
    <meta name="twitter:site" content="@sefgh" />

    <!-- Additional Meta Tags -->
    <meta name="application-name" content="SEFGH" />
    <meta name="theme-color" content="#2563eb" />
    <meta name="msapplication-TileColor" content="#2563eb" />

    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "SEFGH",
        "url": "https://sefgh.org/searchpage",
        "description": "A smart GitHub project discovery tool that helps developers find repositories using natural language queries and intelligent matching based on LLM'S Agentic Frameworks.",
        "applicationCategory": "DeveloperApplication",
        "operatingSystem": "Web Browser",
        "offers": {
          "@type": "Offer",
          "price": "0",
          "priceCurrency": "USD"
        },
        "creator": {
          "@type": "Organization",
          "name": "SEFGH",
          "url": "https://sefgh.org/searchpage"
        },
        "featureList": [
          "Natural language GitHub search",
          "Multi-language project discovery",
          "Smart repository matching",
          "Hidden gem discovery",
          "Detailed project analysis",
          "Search Engine For Github"
        ]
      }
    </script>

    <!-- Additional Structured Data for Organization -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "SEFGH",
        "url": "https://sefgh.org/searchpage",
        "logo": "https://sefgh.org/assets/sefgh-logo.png",
        "description": "SEFGH is a smart GitHub project discovery tool that helps developers find repositories using natural language queries.",
        "foundingDate": "2025",
        "sameAs": ["https://twitter.com/sefghai", "https://github.com/sefgh-ai"]
      }
    </script>


    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SEFGH - AI-Powered GitHub Repository Search</title>
    <link rel="icon" type="image/png" href="./assets/favicon.png" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Using Inter for all text to match the provided image's clean sans-serif style -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Meta Tags -->
    <meta name="description" content="Discover and explore GitHub repositories with AI-powered chat assistance. Search, filter, and analyze projects with intelligent recommendations." />
    <meta name="keywords" content="GitHub, repositories, search, AI, chat, development, code, projects" />
    <meta name="theme-color" content="#111827" />
    
    <!-- CDNs for Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


    <!-- Custom Tailwind Configuration -->
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              // Removed 'stalinist' and kept 'inter' as the primary font
              'sans': ['Inter', 'sans-serif'], // Set Inter as the default sans-serif font
            },
            colors: {
                // Custom modern palette
                primary: {
                    50: '#eef2ff',
                    100: '#e0e7ff',
                    200: '#c7d2fe',
                    300: '#a5b4fc',
                    400: '#818cf8',
                    500: '#6366f1', // Main accent blue
                    600: '#4f46e5',
                    700: '#4338ca',
                    800: '#3730a3',
                    900: '#312e81',
                    950: '#1e1b4b',
                },
                gray: {
                    50: '#f9fafb',
                    100: '#f3f4f6',
                    200: '#e5e7eb',
                    300: '#d1d5db',
                    400: '#9ca3af',
                    500: '#6b7280',
                    600: '#4b5563',
                    700: '#374151',
                    800: '#1f2937',
                    900: '#111827', // Darkest background
                    950: '#030712', // True black for dark mode
                },
            },
            animation: {
              'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'rainbow-shine': 'rainbow-shine 2s linear infinite',
              'fade-in-up': 'fade-in-up 0.5s ease-out forwards',
              'bounce-in': 'bounce-in 0.8s ease-out forwards', /* New animation */
            },
            keyframes: {
              'rainbow-shine': {
                '0%': { 'background-position': '0% 50%' },
                '100%': { 'background-position': '200% 50%' },
              },
              'fade-in-up': {
                '0%': { opacity: '0', transform: 'translateY(10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              },
              /* New keyframe for bounce-in animation */
              'bounce-in': {
                '0%': { opacity: '0', transform: 'scale(0.5) translateY(20px)' },
                '60%': { opacity: '1', transform: 'scale(1.1) translateY(-5px)' },
                '100%': { transform: 'scale(1) translateY(0)' },
              }
            }
          }
        }
      }
    </script>

    <!-- Custom CSS Styles -->
    <style type="text/tailwindcss">
      @layer base {
        html { scroll-behavior: smooth; }
        /* Updated body to use Inter as the default font */
        body { @apply antialiased bg-gray-50 dark:bg-gray-950 text-gray-800 dark:text-gray-200 font-sans; }
      }
      @layer utilities {
        .backdrop-blur-md { backdrop-filter: blur(12px); }
        /* Updated active/inactive nav colors for better contrast */
        .active-nav { @apply bg-primary-100 dark:bg-primary-800 text-primary-800 dark:text-primary-100; }
        .inactive-nav { @apply text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700/60; }

        .hover-rainbow-shine {
            @apply bg-clip-text text-transparent;
        }
        .hover-rainbow-shine:hover {
            background-image: linear-gradient(to right, #ef4444, #f97316, #eab308, #84cc16, #22c55e, #14b8a6, #06b6d4, #3b82f6, #8b5cf6, #d946ef, #ef4444);
            background-size: 200% auto;
            @apply animate-rainbow-shine;
        }
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { @apply bg-gray-100 dark:bg-gray-800; }
      ::-webkit-scrollbar-thumb { @apply bg-gray-400 dark:bg-gray-600 rounded-full; }
      ::-webkit-scrollbar-thumb:hover { @apply bg-gray-500 dark:bg-gray-500; }

      /* Focus & Selection */
      /* Updated focus ring color */
      :focus-visible { @apply ring-2 ring-primary-500 ring-offset-2 ring-offset-white dark:ring-offset-gray-900 outline-none; }
      ::selection { @apply bg-primary-700 text-white; }
      ::-moz-selection { @apply bg-primary-700 text-white; }

      /* Panel transition styles */
      #chat-panel, #search-panel {
        transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      /* Dropdown transition */
      #version-menu {
        transition: opacity 150ms ease-out, transform 150ms ease-out;
      }

      /* Notification styles */
      #notification-container {
          position: fixed;
          top: 1rem;
          left: 50%;
          transform: translateX(-50%);
          z-index: 1000;
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
          width: 90%;
          max-width: 400px;
      }
      .notification-item {
          @apply p-3 rounded-lg shadow-lg flex items-center justify-between text-sm;
          animation: slideIn 0.3s ease-out forwards, fadeOut 0.5s ease-in 6.5s forwards; /* Increased duration to 7s (6.5s fadeOut delay) */
      }
      .notification-item.info {
          @apply bg-blue-500 text-white; /* Changed to blue-500 */
      }
      .notification-item.error {
          @apply bg-red-500 text-white; /* Changed to red-500 */
      }
      .notification-item.success {
          @apply bg-green-500 text-white; /* Changed to green-500 */
      }

      @keyframes slideIn {
          from { transform: translateY(-20px); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
      }
      @keyframes fadeOut {
          from { opacity: 1; }
          to { opacity: 0; }
      }
    </style>
</head>
<body class="overflow-hidden flex">

    <!-- Removed Sidebar -->
    <!-- <nav class="w-16 bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-700 flex flex-col items-center py-4 space-y-4 flex-shrink-0">
        <button id="nav-chat-btn" title="Chat" class="p-2 rounded-lg transition-colors">
            <i data-lucide="message-square" class="w-6 h-6"></i>
        </button>
        <button id="nav-search-btn" title="Toggle Repository Search" class="p-2 rounded-lg transition-colors inactive-nav">
            <i data-lucide="search" class="w-6 h-6"></i>
        </button>
        <button id="nav-history-btn" title="Search History" class="p-2 rounded-lg transition-colors inactive-nav">
            <i data-lucide="history" class="w-6 h-6"></i>
        </button>
    </nav> -->

    <div id="app-container" class="h-screen flex flex-col flex-1">

        <!-- Header -->
        <header class="h-16 bg-white/80 dark:bg-gray-950/80 backdrop-blur-md flex items-center justify-between px-2 sm:px-4 md:px-6 z-50 flex-shrink-0">
            <div class="flex items-center space-x-1 sm:space-x-2 flex-nowrap">
                <!-- Updated logo text to use Inter font with extra-bold weight -->
                <a href="https://sefgh.org" target="_blank" rel="noopener noreferrer" class="text-base sm:text-lg lg:text-xl font-extrabold font-sans hover-rainbow-shine bg-gradient-to-r from-gray-900 to-gray-900 dark:from-gray-200 dark:to-gray-200 flex-shrink-0">SEFGH-AI</a>

                <!-- Re-introduced Version Switcher Dropdown in Header -->
                <div id="version-switcher" class="relative ml-4 flex-shrink-0">
                    <button id="version-toggle-btn" class="flex items-center space-x-2 px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors shadow-sm">
                        <span id="version-name" class="font-semibold text-xs sm:text-sm text-gray-900 dark:text-white flex-shrink-0"></span>
                        <i id="version-chevron" data-lucide="chevron-down" class="w-4 h-4 text-primary-500 flex-shrink-0"></i>
                    </button>
                    <div id="version-menu" class="absolute top-full left-0 mt-2 w-56 bg-white dark:bg-gray-900/95 backdrop-blur-md rounded-lg shadow-xl z-10 hidden origin-top-left" style="transform: scale(0.95); opacity: 0;">
                        <!-- Version items will be injected by JS -->
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-1 sm:space-x-2 md:space-x-4 flex-nowrap">
                <!-- GitHub icon button -->
                <button title="GitHub Repository" class="p-2 rounded-lg text-purple-600 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors flex-shrink-0" onclick="window.open('https://github.com/sefgh-ai/hostSefgh', '_blank')">
                    <i data-lucide="github" class="w-5 h-5"></i>
                </button>
                <!-- New grid icon button -->
                <button title="Layout" class="p-2 rounded-lg text-teal-500 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors flex-shrink-0">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i>
                </button>
                <button id="toggle-search-btn" title="Show Search" class="p-2 rounded-lg text-blue-500 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors flex-shrink-0">
                    <i data-lucide="search" class="w-5 h-5"></i>
                </button>
                <button id="theme-toggle-btn" title="Toggle theme" class="p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors flex-shrink-0">
                    <i data-lucide="moon" class="w-5 h-5"></i>
                </button>
                <button title="User Account" class="p-2 rounded-lg text-green-500 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors flex-shrink-0">
                    <i data-lucide="user" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <!-- Added gap-x-2 for visual separation between chat and search panels -->
        <main id="panel-container" class="flex-1 overflow-hidden flex relative md:gap-x-2">
            
            <!-- Chat Panel -->
            <section id="chat-panel" class="h-full flex flex-col bg-white dark:bg-gray-950 w-full">
                <!-- Removed border-b from this div -->
                <div class="flex items-center justify-end p-4 flex-shrink-0">
                    <button id="clear-history-btn" title="Clear chat history" class="p-2 text-red-500 hover:text-red-600 dark:hover:text-red-400 transition-colors hidden">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
                <form id="chat-form" class="py-2 px-4 bg-white/80 dark:bg-gray-950/80 backdrop-blur-md flex-shrink-0">
                    <!-- Changed items-end to items-center for vertical alignment -->
                    <div class="flex items-center space-x-2 flex-nowrap">
                        <button type="button" title="Find similar repos" class="p-2 text-orange-500 hover:text-orange-600 dark:hover:text-orange-400 transition-colors flex-shrink-0"><i data-lucide="paperclip" class="w-5 h-5"></i></button>
                        <div class="flex-1 relative">
                            <textarea id="chat-textarea" placeholder="e.g., 'Find a lightweight charting library for React'" rows="1" class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg resize-none text-sm max-h-32"></textarea>
                        </div>
                        <!-- Updated send button style -->
                        <button id="send-btn" type="submit" title="Send message" class="p-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-md flex-shrink-0">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                </form>
                <!-- New footer message -->
                <div class="text-xs text-center text-gray-500 dark:text-gray-400 py-1 px-4">
                    SEFGH-Ai is evolving. Confirm essential information
                </div>
            </section>

            <!-- Resize Handle -->
            <!-- Adjusted width and added back the inner rounded indicator -->
            <div id="resize-handle" class="w-1 h-full bg-gray-300 dark:bg-gray-700 hover:bg-gray-500 dark:hover:bg-gray-600 cursor-col-resize flex-shrink-0 transition-colors hidden md:flex items-center justify-center">
                 <div class="w-1.5 h-8 bg-gray-600 dark:bg-gray-500 rounded-full opacity-100"></div>
            </div>

            <!-- Search Panel -->
            <section id="search-panel" class="h-full flex flex-col bg-gray-50 dark:bg-gray-900 absolute inset-0 md:relative hidden">
                <!-- New header for search panel -->
                <div class="flex items-center justify-between py-2 px-4 flex-shrink-0">
                    <div class="flex items-center space-x-2">
                        <i data-lucide="github" class="w-6 h-6 text-gray-600 dark:text-gray-400"></i>
                        <span class="text-base font-semibold text-gray-800 dark:text-gray-200">Repo Search</span>
                    </div>
                    <button id="close-search-panel-btn" title="Close Search" class="p-2 rounded-full text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                 <div class="pt-2 px-4 flex-shrink-0">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                        <!-- Updated search input style -->
                        <input id="search-input" type="text" placeholder="Search GitHub repositories..." class="w-full pl-10 pr-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg text-sm shadow-sm">
                    </div>
                 </div>
                 <div id="search-results-container" class="flex-1 overflow-y-auto p-4">
                    <!-- Search results will be injected here -->
                 </div>
            </section>

             <!-- History Panel -->
            <section id="history-panel" class="h-full w-full flex-col bg-gray-50 dark:bg-gray-900 hidden">
                 <div class="p-4 flex-shrink-0 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Search History</h2>
                    <button id="clear-search-history-btn" title="Clear search history" class="p-2 text-gray-400 hover:text-red-500 dark:hover:text-red-400 transition-colors">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                 </div>
                 <div id="history-container" class="flex-1 overflow-y-auto p-4">
                    <!-- History items will be injected here -->
                 </div>
            </section>
        </main>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- DOM Element Selectors ---
    const getEl = (id) => document.getElementById(id);
    const appContainer = getEl('app-container');
    const panelContainer = getEl('panel-container');
    const notificationContainer = getEl('notification-container'); // New notification container

    // --- State Management ---
    let state = {
        theme: localStorage.getItem('theme') || 'light',
        isSearchVisible: false,
        isTyping: false,
        messages: JSON.parse(localStorage.getItem('chatMessages')) || [],
        searchHistory: JSON.parse(localStorage.getItem('searchHistory')) || [],
        activeView: 'chat', // 'chat' or 'history'
        isResizing: false,
        isVersionDropdownOpen: false, // Re-added for header dropdown
        selectedVersionId: localStorage.getItem('selectedVersionId') || 'v1', // Changed default to 'v1'
        versions: [ // Re-added
            { id: 'v3', name: 'SEFGH v3.0', description: 'Advanced model with contextual understanding.', persona: "Got it. " },
            { id: 'v2', name: 'SEFGH v2.0', description: 'Stable model for reliable keyword searches.', persona: "Okay, " },
            { id: 'v1', name: 'SEFGH v1.0', description: 'Legacy model for direct search term matching.', persona: "Searching: " }
        ],
        editingMessageId: null, // --- NEW: To track which message is being edited
    };
    
    // --- Get all DOM elements ---
    const [
        htmlEl,
        toggleSearchBtn,
        chatPanel,
        searchPanel,
        historyPanel,
        resizeHandle,
        messagesContainer,
        chatForm,
        chatTextarea,
        sendBtn,
        clearHistoryBtn,
        searchInput,
        searchResultsContainer,
        historyContainer,
        clearSearchHistoryBtn,
        // Re-added version switcher elements
        versionToggleBtn,
        versionMenu,
        versionName,
        versionChevron,
        // New search panel close button
        closeSearchPanelBtn,
    ] = [
        document.documentElement,
        getEl('toggle-search-btn'),
        getEl('chat-panel'),
        getEl('search-panel'),
        getEl('history-panel'),
        getEl('resize-handle'),
        getEl('messages-container'),
        getEl('chat-form'),
        getEl('chat-textarea'),
        getEl('send-btn'),
        getEl('clear-history-btn'),
        getEl('search-input'),
        getEl('search-results-container'),
        getEl('history-container'),
        getEl('clear-search-history-btn'),
        // Re-added version switcher elements
        getEl('version-toggle-btn'),
        getEl('version-menu'),
        getEl('version-name'),
        getEl('version-chevron'),
        // New search panel close button
        getEl('close-search-panel-btn'),
    ];
    
    // --- Utility Functions ---
    const debounce = (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; };
    const formatNumber = (num) => num > 999 ? `${(num / 1000).toFixed(1)}k` : num;

    /**
     * Displays a notification message.
     * @param {string} message The message to display.
     * @param {'info'|'success'|'error'} type The type of notification.
     * @param {number} duration The duration in milliseconds before the notification fades out.
     */
    const showNotification = (message, type = 'info', duration = 7000) => { // Increased duration to 7 seconds
        const notificationItem = document.createElement('div');
        notificationItem.className = `notification-item ${type}`;
        notificationItem.innerHTML = `
            <span>${message}</span>
            <button class="ml-4 text-white opacity-75 hover:opacity-100" onclick="this.closest('.notification-item').remove()">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        `;
        notificationContainer.appendChild(notificationItem);
        lucide.createIcons(); // Re-render lucide icons for the new notification

        setTimeout(() => {
            notificationItem.style.opacity = '0';
            notificationItem.style.transform = 'translateY(-20px)';
            setTimeout(() => notificationItem.remove(), 500); // Remove after fade out
        }, duration);
    };

    /**
     * Converts a Markdown string to HTML using marked.js.
     * @param {string} markdownText The input string with Markdown.
     * @returns {string} The HTML formatted string.
     */
    const parseMarkdownToHtml = (markdownText) => {
        // Configure marked.js to add Tailwind classes to generated HTML elements
        const renderer = new marked.Renderer();

        // Customize heading rendering
        renderer.heading = (text, level) => {
            const tag = `h${level}`;
            let classes = '';
            if (level === 1) classes = 'text-xl font-bold mt-4 mb-2';
            else if (level === 2) classes = 'text-lg font-semibold mt-3 mb-1.5';
            else if (level === 3) classes = 'text-base font-medium mt-2.5 mb-1';
            // Add more levels if needed
            return `<${tag} class="${classes}">${text}</${tag}>`;
        };

        // Customize paragraph rendering
        renderer.paragraph = (text) => {
            return `<p class="mb-2 last:mb-0">${text}</p>`;
        };

        // Customize list item rendering
        renderer.listitem = (text) => {
            return `<li class="ml-4 list-disc">${text}</li>`; // Tailwind's list-disc adds the bullet
        };
        
        // Customize code block rendering
        renderer.code = (code, language) => {
            // Basic styling for code blocks, you might want a full syntax highlighter
            return `<pre class="bg-gray-800 text-gray-200 p-3 rounded-md overflow-x-auto my-2 text-sm font-mono"><code class="language-${language}">${code}</code></pre>`;
        };

        // Customize inline code rendering
        renderer.codespan = (code) => {
            return `<code class="bg-gray-200 dark:bg-gray-700 rounded px-1 py-0.5 text-sm font-mono">${code}</code>`;
        };

        // Customize link rendering
        renderer.link = (href, title, text) => {
            return `<a href="${href}" target="_blank" rel="noopener noreferrer" class="text-primary-600 dark:text-primary-400 hover:underline">${text}</a>`;
        };

        // Set options for marked.js
        marked.setOptions({
            renderer: renderer,
            gfm: true, // Use GitHub Flavored Markdown
            breaks: true, // Convert newlines to <br>
            sanitize: true // Sanitize the output to prevent XSS attacks
        });

        return marked.parse(markdownText);
    };


    // --- View & UI Logic ---
    const setActiveView = (view) => {
        console.log(`setActiveView: Switching to view: ${view}`);
        state.activeView = view;
        const isMobile = window.innerWidth < 768; // Define mobile breakpoint

        if (isMobile) {
            console.log("setActiveView: Mobile view detected.");
            // Mobile: Search panel overlays chat panel
            if (state.isSearchVisible) {
                chatPanel.classList.add('hidden'); // Hide chat panel
                searchPanel.classList.remove('hidden'); // Show search panel
                // Ensure search panel is full screen and on top
                searchPanel.classList.add('absolute', 'inset-0', 'z-20'); // z-20 to be above chat
                searchPanel.style.width = '100%'; // Explicitly set width for transition
                resizeHandle.classList.add('hidden'); // Always hide resize handle on mobile
                toggleSearchBtn.innerHTML = `<i data-lucide="x" class="w-5 h-5"></i>`; // Change to close icon
                toggleSearchBtn.title = "Close Search";
                // Show the close button in the search panel header
                closeSearchPanelBtn.classList.remove('hidden');
                console.log("setActiveView: Search panel visible (mobile overlay).");
            } else {
                chatPanel.classList.remove('hidden'); // Show chat panel
                searchPanel.classList.add('hidden'); // Hide search panel
                searchPanel.classList.remove('absolute', 'inset-0', 'z-20'); // Remove overlay styles
                searchPanel.style.width = '0%'; // Collapse search panel
                resizeHandle.classList.add('hidden'); // Always hide resize handle on mobile
                toggleSearchBtn.innerHTML = `<i data-lucide="search" class="w-5 h-5"></i>`; // Change to search icon
                toggleSearchBtn.title = "Show Search";
                // Hide the close button in the search panel header
                closeSearchPanelBtn.classList.add('hidden');
                console.log("setActiveView: Chat panel visible (mobile).");
            }
        } else { // Desktop/Tablet behavior
            console.log("setActiveView: Desktop/Tablet view detected.");
            chatPanel.classList.remove('hidden'); // Ensure chat is visible
            searchPanel.classList.remove('absolute', 'inset-0', 'z-20'); // Remove mobile overlay styles
            
            if (state.isSearchVisible) {
                searchPanel.classList.remove('hidden');
                resizeHandle.classList.remove('hidden');
                const gapWidth = 8;
                chatPanel.style.width = `calc(40% - ${gapWidth / 2}px)`;
                searchPanel.style.width = `calc(${60}% - ${gapWidth / 2}px)`;
                toggleSearchBtn.innerHTML = `<i data-lucide="message-square" class="w-5 h-5"></i>`; // Change to message icon
                toggleSearchBtn.title = "Hide Search";
                // Hide the close button in the search panel header (only relevant for mobile overlay)
                closeSearchPanelBtn.classList.add('hidden');
                console.log("setActiveView: Search panel visible (desktop split).");
            } else {
                searchPanel.classList.add('hidden');
                resizeHandle.classList.add('hidden');
                chatPanel.style.width = '100%';
                searchPanel.style.width = '0%';
                toggleSearchBtn.innerHTML = `<i data-lucide="search" class="w-5 h-5"></i>`; // Change to search icon
                toggleSearchBtn.title = "Show Search";
                // Hide the close button in the search panel header
                closeSearchPanelBtn.classList.add('hidden');
                console.log("setActiveView: Chat panel visible (desktop full).");
            }
        }
        lucide.createIcons();
    };

    const toggleSearchView = () => {
        console.log("toggleSearchView: Toggling search view visibility.");
        state.isSearchVisible = !state.isSearchVisible;
        setActiveView(state.activeView); // Re-use setActiveView to apply changes
    };

    // --- Chat History Logic ---
    const saveMessages = () => localStorage.setItem('chatMessages', JSON.stringify(state.messages));
    
    // --- MODIFIED: `renderMessages` and `renderSingleMessage` for new icon placement ---
    const renderMessages = () => {
        console.log("renderMessages: Rendering chat messages.");
        messagesContainer.innerHTML = '';
        const renderSingleMessage = (msg, isTyping = false) => {
            const isUser = msg.role === 'user';
            const formattedTime = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            if (state.editingMessageId === msg.id) {
                console.log(`renderSingleMessage: Rendering message ${msg.id} in edit mode.`);
                return `
                <div class="flex items-start space-x-3 justify-end">
                    <div class="max-w-xs lg:max-w-md xl:max-w-lg order-1 w-full">
                        <div class="p-3 rounded-xl bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 shadow-sm">
                            <textarea class="w-full px-2 py-1 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md resize-y text-sm" rows="3">${msg.rawContent}</textarea>
                            <div class="mt-2 flex justify-end space-x-2">
                                <button data-action="cancel-edit" class="px-3 py-1 text-xs font-semibold rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">Cancel</button>
                                <button data-action="save-edit" data-message-id="${msg.id}" class="px-3 py-1 text-xs font-semibold rounded-md bg-primary-600 text-white hover:bg-primary-700">Save & Submit</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex-shrink-0 w-8 h-8 bg-primary-200 dark:bg-primary-700 rounded-full flex items-center justify-center order-2"><i data-lucide="user" class="w-4 h-4 text-primary-800 dark:text-primary-200"></i></div>
                </div>`;
            }

            const actionButtons = `
                <div class="mt-1 flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity ${isUser ? 'justify-end' : ''}">
                    ${isUser ? `<button data-action="edit" data-message-id="${msg.id}" title="Edit" class="p-1 text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"><i data-lucide="pencil" class="w-3.5 h-3.5 pointer-events-none"></i></button>` : ''}
                    ${!isUser ? `<button data-action="regenerate" data-message-id="${msg.id}" title="Regenerate" class="p-1 text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"><i data-lucide="refresh-cw" class="w-3.5 h-3.5 pointer-events-none"></i></button>` : ''}
                    <button data-action="copy-message" data-copy-content="${encodeURIComponent(msg.rawContent)}" title="Copy message" class="p-1 text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"><i data-lucide="copy" class="w-3.5 h-3.5 pointer-events-none"></i></button>
                    <button data-action="delete-message" data-message-id="${msg.id}" title="Delete message" class="p-1 text-red-400 hover:text-red-600 dark:hover:text-red-300"><i data-lucide="trash-2" class="w-3.5 h-3.5 pointer-events-none"></i></button>
                </div>
            `;

            return `
            <div class="flex items-start space-x-3 ${isUser ? 'justify-end' : ''} group relative animate-fade-in-up">
                ${!isUser ? `<div class="flex-shrink-0 w-8 h-8 bg-primary-600 dark:bg-primary-700 rounded-full flex items-center justify-center overflow-hidden"><img src="https://v1.sefgh.org/assets/favicon.png" alt="Bot Icon" class="w-full h-full object-cover"></div>` : ''}
                <div class="max-w-xs lg:max-w-md xl:max-w-lg ${isUser ? 'order-1' : ''}">
                    <div class="px-4 py-3 rounded-xl ${isUser ? 'bg-primary-600 text-white' : 'bg-gray-100 dark:bg-gray-800'} shadow-md">
                        <div class="text-sm whitespace-pre-wrap">${msg.htmlContent}${isTyping ? '<span class="inline-flex items-center ml-2"><span class="w-1.5 h-1.5 bg-current rounded-full animate-pulse"></span><span class="w-1.5 h-1.5 bg-current rounded-full animate-pulse delay-150 ml-1"></span><span class="w-1.5 h-1.5 bg-current rounded-full animate-pulse delay-300 ml-1"></span></span>' : ''}</div>
                    </div>
                    <div class="mt-1 flex items-center justify-between">
                        ${!isTyping ? `<div class="text-xs text-gray-500 dark:text-gray-400 ${isUser ? 'ml-auto' : ''}">${formattedTime}</div>` : '<div></div>' }
                    </div>
                    ${!isTyping && !state.isTyping ? actionButtons : ''}
                </div>
                ${isUser ? `<div class="flex-shrink-0 w-8 h-8 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center order-2"><i data-lucide="user" class="w-4 h-4 text-gray-600 dark:text-gray-400"></i></div>` : ''}
            </div>`;
        };

        if (state.messages.length === 0 && !state.isTyping) {
            messagesContainer.innerHTML = `
                <div class="text-center text-gray-500 dark:text-gray-400 mt-8">
                    <i data-lucide="message-square" class="w-12 h-12 mx-auto mb-4 text-primary-500 animate-bounce-in"></i>
                    <h3 class="text-lg font-medium mb-2 animate-fade-in-up">Welcome to SEFGH!</h3>
                    <p class="text-sm animate-fade-in-up" style="animation-delay: 0.2s;">How can I help you explore GitHub today?</p>
                </div>`;
            clearHistoryBtn.classList.add('hidden');
        } else {
            messagesContainer.innerHTML = state.messages.map(msg => renderSingleMessage(msg)).join('');
            clearHistoryBtn.classList.remove('hidden');
        }
        if (state.isTyping) {
            // Pass an empty string for content when rendering the typing indicator
            messagesContainer.innerHTML += renderSingleMessage({ role: 'assistant', rawContent: '', htmlContent: '' }, true);
        }
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        lucide.createIcons();
    };
    
    // Modified addMessage to store both raw and HTML content
    const addMessage = (content, role) => { 
        console.log(`addMessage: Adding message - Role: ${role}, Content: "${content}"`);
        // Use marked.parse for assistant messages
        const htmlContent = role === 'assistant' ? marked.parse(content) : content; 
        state.messages.push({ id: Date.now(), rawContent: content, htmlContent, role, timestamp: new Date() }); 
        saveMessages(); 
        renderMessages(); 
    };
    const clearChatHistory = () => { 
        console.log("clearChatHistory: Clearing chat history.");
        state.messages = []; 
        saveMessages(); 
        renderMessages(); 
    };
    const handleSendMessage = (e) => { 
        e.preventDefault(); 
        const message = chatTextarea.value.trim(); 
        if (!message) return; // Prevent sending empty messages

        if (state.selectedVersionId !== 'v1') {
            showNotification("The AI API is only enabled for SEFGH v1.0. Please switch to v1.0 to use AI features.", 'info');
            chatTextarea.value = ''; // Clear input
            chatTextarea.style.height = 'auto'; 
            updateChatInputState(); 
            return; // Do not process or display the message
        }

        if (!state.isTyping) { 
            console.log(`handleSendMessage: User input received: "${message}"`);
            addMessage(message, 'user'); 
            chatTextarea.value = ''; 
            chatTextarea.style.height = 'auto'; 
            updateChatInputState(); 
            processUserMessage(message); 
        } 
    };
    const updateChatInputState = () => {
        const hasText = chatTextarea.value.trim().length > 0;
        sendBtn.disabled = !hasText || state.isTyping;
        chatTextarea.disabled = state.isTyping;

        // Dynamically add/remove overflow-y-auto based on scrollHeight
        if (chatTextarea.scrollHeight > chatTextarea.clientHeight) {
            chatTextarea.classList.add('overflow-y-auto');
        } else {
            chatTextarea.classList.remove('overflow-y-auto');
        }
    };

    // --- Search History Logic ---
    const saveSearchHistory = (query) => {
        console.log(`saveSearchHistory: Saving search query: "${query}"`);
        const trimmedQuery = query.trim();
        if (!trimmedQuery || state.searchHistory.includes(trimmedQuery)) return;
        state.searchHistory.unshift(trimmedQuery);
        if (state.searchHistory.length > 50) state.searchHistory.pop();
        localStorage.setItem('searchHistory', JSON.stringify(state.searchHistory));
        renderHistoryPanel();
    };
    const renderHistoryPanel = () => {
        console.log("renderHistoryPanel: Rendering search history panel.");
        // This panel is no longer directly accessible via a sidebar button.
        // It will remain hidden unless logic is added to show it elsewhere.
        if (state.searchHistory.length === 0) {
            historyContainer.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 mt-8"><i data-lucide="search-x" class="w-12 h-12 mx-auto mb-4 text-red-400"></i><h3 class="text-lg font-medium mb-2">No Search History</h3><p class="text-sm">Your past searches will appear here.</p></div>`;
            clearSearchHistoryBtn.classList.add('hidden');
        } else {
            historyContainer.innerHTML = `<ul class="space-y-2">${state.searchHistory.map(term => `<li><button class="history-item-btn w-full text-left p-3 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700/80 transition-colors flex justify-between items-center shadow-sm" data-query="${term}"><span class="font-medium text-gray-800 dark:text-gray-200 pointer-events-none">${term}</span><i data-lucide="search" class="w-4 h-4 text-gray-400 pointer-events-none"></i></button></li>`).join('')}</ul>`;
            clearSearchHistoryBtn.classList.remove('hidden');
        }
        lucide.createIcons();
    };
    const clearSearchHistory = () => { 
        console.log("clearSearchHistory: Clearing search history.");
        state.searchHistory = []; 
        localStorage.removeItem('searchHistory'); 
        renderHistoryPanel(); 
    };

    // --- Repository Search Logic ---
    const searchRepositories = async (query) => { 
        console.log(`searchRepositories: Initiating search for: "${query}"`);
        if (!query || query.length < 2) { 
            console.log("searchRepositories: Query too short, rendering initial search state.");
            renderSearchInitial(); 
            return; 
        } 
        saveSearchHistory(query); 
        renderSearchLoading(); 
        try { 
            const response = await fetch(`https://api.github.com/search/repositories?q=${encodeURIComponent(query)}&sort=stars&per_page=20`); 
            if (!response.ok) {
                const errorData = await response.json();
                const errorMessage = errorData.message || `API Error: ${response.status}`;
                console.error("searchRepositories: GitHub API error:", errorMessage);
                throw new Error(errorMessage);
            }
            const data = await response.json(); 
            console.log("searchRepositories: GitHub API response received:", data);
            if (data.items.length === 0) {
                console.log("searchRepositories: No results found.");
                renderSearchEmpty(query); 
            } else {
                console.log(`searchRepositories: Found ${data.items.length} results.`);
                renderSearchResults(data.items); 
            }
        } catch (error) { 
            console.error("searchRepositories: Search failed:", error.message);
            renderSearchError(error.message); 
        } 
    };
    const renderSearchInitial = () => { console.log("renderSearchInitial: Displaying initial search prompt."); searchResultsContainer.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 mt-8"><i data-lucide="folder-search" class="w-16 h-16 mx-auto mb-4 text-primary-400"></i><h3 class="text-lg font-medium mb-2">Repository Search</h3><p class="text-sm">Results from your chat will appear here.</p></div>`; lucide.createIcons(); };
    const renderSearchLoading = () => { console.log("renderSearchLoading: Displaying search loading skeletons."); let skeletons = Array(5).fill('').map(() => `<div class="bg-white dark:bg-gray-700 p-4 rounded-xl shadow-md animate-pulse-fast"><div class="h-4 bg-gray-200 dark:bg-gray-600 rounded w-3/4 mb-3"></div><div class="h-3 bg-gray-200 dark:bg-gray-600 rounded w-full mb-1"></div><div class="h-3 bg-gray-200 dark:bg-gray-600 rounded w-5/6 mb-4"></div><div class="flex items-center space-x-4"><div class="h-4 bg-gray-200 dark:bg-gray-600 rounded w-1/4"></div><div class="h-4 bg-gray-200 dark:bg-gray-600 rounded w-1/4"></div></div></div>`).join(''); searchResultsContainer.innerHTML = `<div class="space-y-4">${skeletons}</div>`; lucide.createIcons(); };
    const renderSearchResults = (items) => { console.log("renderSearchResults: Displaying search results."); const cardsHtml = items.map(item => `<div class="bg-white dark:bg-gray-800/50 p-4 rounded-xl border border-gray-200 dark:border-gray-700/50 shadow-md hover:shadow-lg hover:border-primary-500 dark:hover:border-primary-400 transition-all duration-200"><div class="flex justify-between items-start"><a href="${item.html_url}" target="_blank" rel="noopener noreferrer" class="font-semibold text-gray-800 dark:text-gray-200 hover:underline mb-1 pr-2">${item.full_name}</a><div class="flex-shrink-0 flex items-center space-x-3 text-gray-500 dark:text-gray-400"><span class="flex items-center text-sm"><i data-lucide="star" class="w-4 h-4 mr-1 text-yellow-500"></i>${formatNumber(item.stargazers_count)}</span><span class="flex items-center text-sm"><i data-lucide="git-fork" class="w-4 h-4 mr-1 text-purple-400"></i>${formatNumber(item.forks_count)}</span></div></div><p class="text-sm text-gray-600 dark:text-gray-300 my-2">${item.description || 'No description provided.'}</p><div class="flex items-center justify-between mt-3 text-xs text-gray-500 dark:text-gray-400"><div class="flex items-center space-x-4">${item.language ? `<span class="flex items-center"><i data-lucide="code" class="w-3 h-3 mr-1.5 text-cyan-400"></i>${item.language}</span>` : ''}${item.license ? `<span class="flex items-center"><i data-lucide="scale" class="w-3 h-3 mr-1.5 text-green-400"></i>${item.license.spdx_id}</span>` : ''}</div><span>Updated ${new Date(item.updated_at).toLocaleDateString()}</span></div><div class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-700 flex items-center space-x-2"><button class="copy-btn text-xs bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 px-2 py-1 rounded-md flex items-center" data-copy="${item.html_url}"><i data-lucide="link" class="w-3 h-3 mr-1.5 text-indigo-400"></i>Copy URL</button><button class="copy-btn text-xs bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 px-2 py-1 rounded-md flex items-center" data-copy="${item.clone_url}"><i data-lucide="terminal" class="w-3 h-3 mr-1.5 text-emerald-400"></i>Copy Clone</button></div></div>`).join(''); searchResultsContainer.innerHTML = `<div class="space-y-4">${cardsHtml}</div>`; lucide.createIcons(); };
    const renderSearchEmpty = (query) => { console.log(`renderSearchEmpty: No results for query: "${query}"`); searchResultsContainer.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 mt-8"><i data-lucide="search-x" class="w-16 h-16 mx-auto mb-4 text-red-400"></i><h3 class="text-lg font-medium mb-2">No Results Found</h3><p class="text-sm">Your search for "${query}" did not match any repositories.</p></div>`; lucide.createIcons(); };
    const renderSearchError = (message) => { console.error(`renderSearchError: Displaying search error: "${message}"`); searchResultsContainer.innerHTML = `<div class="text-center text-red-500 dark:text-red-400 mt-8 p-4 bg-red-50 dark:bg-red-900/20 rounded-lg"><i data-lucide="alert-triangle" class="w-16 h-16 mx-auto mb-4 text-red-600"></i><h3 class="text-lg font-medium mb-2">An Error Occurred</h3><p class="text-sm">${message}</p></div>`; lucide.createIcons(); };
    
    // This function is now simplified as its logic is mostly handled in processUserMessage
    const handleSearchTrigger = (query) => { 
        console.log(`handleSearchTrigger: Called with query: "${query}"`);
        // This function is primarily for external triggers.
        // Direct handling of search panel visibility and search initiation is now in processUserMessage.
        // Keeping it here for potential future direct calls or clarity.
    };
    
    // --- Resize Logic ---
    const handleResizeMouseDown = (e) => { e.preventDefault(); state.isResizing = true; appContainer.style.cursor = 'col-resize'; document.addEventListener('mousemove', handleResizeMouseMove); document.addEventListener('mouseup', handleResizeMouseUp); };
    const handleResizeMouseMove = (e) => {
        const isMobile = window.innerWidth < 768;
        if (isMobile || !state.isResizing) return; // Disable resizing on mobile

        const containerRect = panelContainer.getBoundingClientRect();
        const gapWidth = 8; // Corresponds to Tailwind's gap-x-2
        
        // Calculate new chat panel width based on mouse position relative to container
        let newChatWidthPx = e.clientX - containerRect.left;
        
        // Convert to percentage, adjusting for the gap
        let newChatWidthPercent = ((newChatWidthPx - (gapWidth / 2)) / (containerRect.width - gapWidth)) * 100;

        // Constrain widths to prevent panels from becoming too small
        const constrainedChatWidth = Math.max(25, Math.min(75, newChatWidthPercent));
        
        // Apply calculated widths, accounting for the gap
        chatPanel.style.width = `calc(${constrainedChatWidth}% - ${gapWidth / 2}px)`;
        searchPanel.style.width = `calc(${100 - constrainedChatWidth}% - ${gapWidth / 2}px)`;
    };
    const handleResizeMouseUp = () => { state.isResizing = false; appContainer.style.cursor = 'default'; document.removeEventListener('mousemove', handleResizeMouseMove); document.removeEventListener('mouseup', handleResizeMouseUp); };
    
    // --- Version Switcher Logic (Re-introduced and modified for header) ---
    const renderVersionDropdown = () => {
        const versionMenuEl = getEl('version-menu'); // Renamed to avoid conflict with local variable
        const versionNameEl = getEl('version-name'); // Renamed
        const versionChevronEl = getEl('version-chevron'); // Renamed
        const selectedVersion = state.versions.find(v => v.id === state.selectedVersionId);
        versionNameEl.textContent = selectedVersion.name;
        if (state.isVersionDropdownOpen) { versionMenuEl.classList.remove('hidden'); setTimeout(() => { versionMenuEl.style.transform = 'scale(1)'; versionMenuEl.style.opacity = '1'; }, 10); versionChevronEl.setAttribute('data-lucide', 'chevron-up'); } else { versionMenuEl.style.transform = 'scale(0.95)'; versionMenuEl.style.opacity = '0'; setTimeout(() => { versionMenuEl.classList.add('hidden'); }, 150); versionChevronEl.setAttribute('data-lucide', 'chevron-down'); }
        versionMenuEl.innerHTML = state.versions.map(v => `<button class="version-item w-full text-left flex flex-col p-2 hover:bg-gray-100 dark:hover:bg-slate-700/50 transition-colors" data-version-id="${v.id}"><span class="font-semibold text-sm pointer-events-none ${v.id === state.selectedVersionId ? 'text-primary-800 dark:text-primary-100' : 'text-gray-800 dark:text-gray-200'}">${v.name}</span><span class="text-xs text-gray-500 dark:text-gray-400 mt-1 pointer-events-none">${v.description}</span></button>`).join('');
        lucide.createIcons();
    };

    // --- AI Response Logic ---
    const processUserMessage = async (userInput) => {
        console.log(`processUserMessage: Starting for input: "${userInput}"`);
        state.isTyping = true;
        renderMessages();
        updateChatInputState(); 

        const API_URL = 'https://api.sefgh.org';

        // Check if the selected version is v1.0, otherwise, prevent API call
        if (state.selectedVersionId !== 'v1') {
            state.isTyping = false;
            renderMessages(); // Re-render to remove typing indicator
            updateChatInputState();
            showNotification("The AI API is only enabled for SEFGH v1.0. Please switch to v1.0 to use AI features.", 'info');
            console.log("processUserMessage: API call skipped because selected version is not v1.0.");
            return; // Exit the function
        }

        try {
            // Get the last 4 messages (or fewer if not enough)
            const conversationHistory = state.messages.slice(-4); 
            console.log("processUserMessage: Conversation history for API call (last 4 messages):", conversationHistory);
            
            // Format the conversation history into a single string
            let formattedHistory = "";
            conversationHistory.forEach(msg => {
                // Use rawContent for sending to API to avoid HTML tags in prompt
                formattedHistory += `${msg.role === 'user' ? 'User' : 'Assistant'}: ${msg.rawContent}\n`; 
            });

            // Add the current user input to the formatted history
            formattedHistory += `User: ${userInput}`;
            console.log("processUserMessage: Formatted history sent to API:", formattedHistory);

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', },
                body: JSON.stringify({ message: formattedHistory }), // Send the formatted history
            });

            state.isTyping = false;
            if (!response.ok) {
                let errorText = `An API error occurred: ${response.status} ${response.statusText}`;
                try {
                    const errorData = await response.json();
                    errorText = errorData.detail || errorData.message || errorText;
                } catch (jsonError) {
                    console.error("processUserMessage: Error parsing API error response:", jsonError);
                }
                console.error("processUserMessage: API response not OK:", errorText);
                throw new Error(errorText);
            }
            const data = await response.json();
            console.log("processUserMessage: Raw API response data:", data);

            // The key change: The API returns the JSON *within* the 'message' field.
            if (data && data.message) { 
                let assistantRawMessage = data.message; // Store the raw message
                let extractedQuery = null;

                // Attempt to extract JSON from the assistant's message
                // This regex looks for a string starting with '{' and ending with '}'
                // and specifically contains '"query": "..."' inside it.
                const jsonRegex = /\{[\s\S]*?"query"\s*:\s*"[^"]*"[\s\S]*?\}/;
                const jsonMatch = assistantRawMessage.match(jsonRegex);
                
                if (jsonMatch) {
                    console.log("processUserMessage: Found potential JSON in assistant message.");
                    try {
                        const jsonString = jsonMatch[0];
                        const parsedContent = JSON.parse(jsonString);
                        
                        if (parsedContent.query) {
                            extractedQuery = parsedContent.query;
                            
                            // Remove the JSON block from the raw message
                            assistantRawMessage = assistantRawMessage.replace(jsonString, '').trim();

                            // If the parsed JSON also contains a 'message' field,
                            // and the remaining part of the original message is empty or just whitespace,
                            // then use the 'message' from the JSON as the primary display message.
                            if (parsedContent.message && assistantRawMessage === "") {
                                assistantRawMessage = parsedContent.message;
                            }
                        }
                        console.log("processUserMessage: Successfully extracted and parsed JSON from assistant message.");
                        console.log("processUserMessage: Raw assistant message after JSON extraction:", assistantRawMessage);
                        console.log("processUserMessage: Extracted query:", extractedQuery);

                    } catch (parseError) {
                        console.warn("processUserMessage: Could not parse embedded JSON from assistant message, treating as plain text:", parseError);
                        extractedQuery = null; // Reset in case of parse error
                    }
                }

                // Add the primary assistant message to chat (will be parsed to HTML by addMessage)
                addMessage(assistantRawMessage, 'assistant');
                console.log("processUserMessage: Added AI message to chat.");

                // If a query was extracted, initiate the search process
                if (extractedQuery) {
                    addMessage(`AI initiated search for: "${extractedQuery}"`, 'assistant');
                    console.log(`processUserMessage: AI generated query: "${extractedQuery}". Opening search panel and initiating search.`);
                    
                    // Ensure search panel is visible and activated
                    state.isSearchVisible = true; 
                    setActiveView(state.activeView); 
                    
                    searchInput.value = extractedQuery; // Populate search input
                    searchRepositories(extractedQuery); // Trigger search
                }
            } else {
                console.error("processUserMessage: Received an incomplete or invalid response from the AI: No data.message.");
                throw new Error("Received an incomplete or invalid response from the AI.");
            }
        } catch (error) {
            console.error("processUserMessage: LLM API Call failed:", error);
            state.isTyping = false;
            const userFriendlyError = "My apologies, I'm having trouble connecting to my core intelligence right now. Please check your internet connection or try again in a moment.";
            addMessage(userFriendlyError, 'assistant');
        } finally {
            if (state.isTyping) { state.isTyping = false; }
            renderMessages();
            updateChatInputState();
            console.log("processUserMessage: Finished processing user message.");
        }
    };

    // --- Event Listeners Setup ---
    const setupEventListeners = () => {
        console.log("setupEventListeners: Setting up event listeners.");
        // Header listeners
        toggleSearchBtn.addEventListener('click', toggleSearchView); 
        getEl('theme-toggle-btn').addEventListener('click', () => { 
            console.log("Theme toggle clicked.");
            state.theme = state.theme === 'light' ? 'dark' : 'light'; 
            localStorage.setItem('theme', state.theme); 
            htmlEl.className = state.theme; 
            getEl('theme-toggle-btn').innerHTML = state.theme === 'dark' ? '<i data-lucide="sun" class="w-5 h-5 text-yellow-500"></i>' : '<i data-lucide="moon" class="w-5 h-5 text-indigo-400"></i>'; 
            lucide.createIcons(); 
        });
        
        // Chat listeners
        chatForm.addEventListener('submit', handleSendMessage);
        clearHistoryBtn.addEventListener('click', clearChatHistory);
        chatTextarea.addEventListener('input', () => { 
            chatTextarea.style.height = 'auto'; 
            chatTextarea.style.height = `${chatTextarea.scrollHeight}px`; 
            updateChatInputState(); 
        });
        chatTextarea.addEventListener('keydown', (e) => { 
            if (e.key === 'Enter' && !e.shiftKey) { 
                console.log("Chat textarea: Enter key pressed (no shift).");
                e.preventDefault(); 
                handleSendMessage(e); 
            } 
        });

        // Event delegation for message actions (Edit, Save, Cancel, Regenerate, Copy, Delete)
        messagesContainer.addEventListener('click', (e) => {
            if (state.isTyping) {
                console.log("messagesContainer: Ignoring click, AI is typing.");
                return; // Don't allow actions while AI is responding
            }
            const button = e.target.closest('button[data-action]');
            if (!button) return;

            const action = button.dataset.action;
            const messageId = parseInt(button.dataset.messageId, 10);
            console.log(`messagesContainer: Action "${action}" triggered for message ID: ${messageId}`);

            switch(action) {
                case 'edit':
                    state.editingMessageId = messageId;
                    renderMessages();
                    break;
                
                case 'cancel-edit':
                    state.editingMessageId = null;
                    renderMessages();
                    break;
                
                case 'save-edit':
                    const messageWrapper = button.closest('.max-w-xs');
                    const textarea = messageWrapper.querySelector('textarea');
                    const newContent = textarea.value.trim();
                    const msgIndex = state.messages.findIndex(m => m.id === messageId);

                    if (newContent && msgIndex !== -1 && state.messages[msgIndex].rawContent !== newContent) {
                        console.log(`messagesContainer: Saving edited message ${messageId} and re-submitting.`);
                        // Prune conversation from this point
                        state.messages = state.messages.slice(0, msgIndex);
                        state.editingMessageId = null;
                        
                        // Add the edited message back and re-submit
                        addMessage(newContent, 'user');
                        processUserMessage(newContent);
                    } else {
                        console.log(`messagesContainer: Edit canceled or content unchanged for message ${messageId}.`);
                        // Content is the same or empty, just cancel
                        state.editingMessageId = null;
                        renderMessages();
                    }
                    break;
                
                case 'regenerate':
                    console.log(`messagesContainer: Regenerating response for message ID: ${messageId}.`);
                    const assistantMsgIndex = state.messages.findIndex(m => m.id === messageId);
                    // Find the user prompt that came right before this assistant message
                    if (assistantMsgIndex > 0 && state.messages[assistantMsgIndex - 1].role === 'user') {
                        const userPrompt = state.messages[assistantMsgIndex - 1].rawContent; // Use rawContent for regeneration
                        // Prune conversation from the assistant message onwards
                        state.messages = state.messages.slice(0, assistantMsgIndex);
                        saveMessages();
                        renderMessages();
                        processUserMessage(userPrompt);
                    } else {
                        console.warn(`messagesContainer: Could not find a preceding user prompt to regenerate for message ID: ${messageId}.`);
                    }
                    break;
                
                case 'copy-message':
                    const contentToCopy = decodeURIComponent(button.dataset.copyContent);
                    document.execCommand('copy', false, contentToCopy);
                    const originalCopyHtml = button.innerHTML;
                    button.innerHTML = `<i data-lucide="check" class="w-3.5 h-3.5 text-green-500 pointer-events-none"></i>`;
                    lucide.createIcons();
                    setTimeout(() => {
                        button.innerHTML = originalCopyHtml;
                        lucide.createIcons();
                    }, 2000);
                    showNotification("Message copied to clipboard!", 'success', 3000); // Changed to 'success'
                    break;

                case 'delete-message':
                    console.log(`messagesContainer: Deleting message ID: ${messageId}.`);
                    state.messages = state.messages.filter(msg => msg.id !== messageId);
                    saveMessages();
                    renderMessages();
                    showNotification("Message deleted.", 'info', 3000);
                    break;
            }
        });

        // Search & History Listeners
        resizeHandle.addEventListener('mousedown', handleResizeMouseDown);
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                console.log("Search input: Enter key pressed.");
                e.preventDefault(); // Prevent default form submission if input is part of a form
                searchRepositories(searchInput.value);
            }
        });
        searchResultsContainer.addEventListener('click', (e) => { 
            const button = e.target.closest('.copy-btn'); 
            if (button) { 
                console.log(`Copy button clicked for: "${button.dataset.copy}"`);
                document.execCommand('copy', false, button.dataset.copy); 
                const originalText = button.innerHTML; 
                button.innerHTML = `<i data-lucide="check" class="w-3 h-3 mr-1.5 text-green-500"></i>Copied!`; 
                lucide.createIcons(); 
                setTimeout(() => { 
                    button.innerHTML = originalText; 
                    lucide.createIcons(); 
                }, 2000); 
            } 
        });
        clearSearchHistoryBtn.addEventListener('click', clearSearchHistory);
        closeSearchPanelBtn.addEventListener('click', toggleSearchView); // Added listener for the new close button

        // Version Switcher Listeners (Re-added for header)
        const versionToggleBtnEl = getEl('version-toggle-btn');
        const versionMenuEl = getEl('version-menu');
        versionToggleBtnEl.addEventListener('click', (e) => { 
            e.stopPropagation(); 
            state.isVersionDropdownOpen = !state.isVersionDropdownOpen; 
            renderVersionDropdown(); 
            console.log(`Version dropdown toggled. Open: ${state.isVersionDropdownOpen}`);
        });
        document.addEventListener('click', () => { 
            if (state.isVersionDropdownOpen) { 
                state.isVersionDropdownOpen = false; 
                renderVersionDropdown(); 
                console.log("Version dropdown closed by outside click.");
            } 
        });
        versionMenuEl.addEventListener('click', (e) => {
            const item = e.target.closest('.version-item');
            if (item) {
                e.stopPropagation(); 
                const versionId = item.dataset.versionId;
                if (state.selectedVersionId !== versionId) {
                    console.log(`Version changed from ${state.selectedVersionId} to ${versionId}.`);
                    state.selectedVersionId = versionId; 
                    localStorage.setItem('selectedVersionId', versionId);
                    const newVersion = state.versions.find(v => v.id === versionId);
                    showNotification(`Switched to ${newVersion.name}.`, 'info'); // Changed to notification
                }
                state.isVersionDropdownOpen = false; 
                renderVersionDropdown();
            }
        });
    };

    // --- Initialization ---
    const init = () => {
        console.log("init: Application initialization started.");
        htmlEl.className = state.theme;
        getEl('theme-toggle-btn').innerHTML = state.theme === 'light' ? '<i data-lucide="sun" class="w-5 h-5 text-yellow-500"></i>' : '<i data-lucide="moon" class="w-5 h-5 text-indigo-400"></i>';
        renderMessages();
        renderSearchInitial();
        renderVersionDropdown(); // Re-added call to render dropdown
        renderHistoryPanel(); // Keeping this for now, but it's not accessible.
        setActiveView('chat'); // This will handle initial visibility and widths
        updateChatInputState();
        setupEventListeners();
        lucide.createIcons();

        // Add a resize listener to adjust layout if window size changes between mobile/desktop
        window.addEventListener('resize', debounce(() => {
            console.log("Window resized. Re-evaluating active view layout.");
            setActiveView(state.activeView); // Re-evaluate layout on resize
        }, 200));
        console.log("init: Application initialization complete.");
    };
    
    // --- Run application ---
    init();
});
</script>

</body>
</html>
